<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>My Polaroid Album</title>
    <style>
        /* 1. Ï†ÑÏ≤¥ Î∞∞Ïπò */
        body {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            background-color: #ddd;
            background-image: radial-gradient(#bbb 1px, transparent 1px);
            background-size: 20px 20px;
            margin: 0;
            overflow: hidden;
            font-family: 'Courier New', Courier, monospace;
            touch-action: manipulation;
        }

        /* 2. Î©îÏù∏ Ïª®ÌÖåÏù¥ÎÑà */
        .main-container {
            display: flex;
            align-items: flex-start;
            gap: 30px;
            padding: 20px;
        }

        /* Ïπ¥Î©îÎùº ÏòÅÏó≠ */
        .camera-section {
            position: relative;
            z-index: 20;
        }

        .camera-body {
            width: 300px;
            height: 320px;
            background-color: #fdf5e6;
            border-radius: 40px;
            box-shadow: 15px 15px 35px rgba(0,0,0,0.2);
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
            border: 4px solid #f0f0f0;
        }

        .lens-ring {
            width: 190px;
            height: 190px;
            background: #d3d3d3;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            box-shadow: inset 5px 5px 15px rgba(0,0,0,0.2);
        }

        .lens-inner {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            overflow: hidden;
            background: #000;
            border: 8px solid #333;
        }

        video {
            width: 100%; height: 100%; object-fit: cover; transform: scaleX(-1);
        }

        /* ÏÖîÌÑ∞ Î≤ÑÌäº */
        .shutter-btn {
            position: absolute;
            bottom: 35px; left: 25px;
            width: 50px; height: 50px;
            background-color: #ff7f50;
            border-radius: 50%;
            border: 4px solid #fff;
            box-shadow: 2px 2px 5px rgba(0,0,0,0.3);
            cursor: pointer;
            transition: transform 0.1s;
        }
        .shutter-btn:active { transform: scale(0.9); }
        .shutter-btn.disabled { background-color: #ccc; pointer-events: none; }

        .print-slot {
            position: absolute;
            top: -10px; left: 50%;
            transform: translateX(-50%);
            width: 160px; height: 12px;
            background: #222;
            border-radius: 6px;
            z-index: 10;
        }

        /* 3. Í∞§Îü¨Î¶¨ Î≥¥Í¥ÄÌï® */
        .gallery-box {
            width: 360px;
            height: 500px;
            background: rgba(255, 255, 255, 0.5);
            border-radius: 20px;
            padding: 20px;
            box-shadow: inset 2px 2px 10px rgba(0,0,0,0.1);
            overflow-y: auto;
            display: flex;
            flex-wrap: wrap;
            align-content: flex-start;
            gap: 15px;
        }

        .gallery-title {
            width: 100%;
            text-align: center;
            margin-bottom: 10px;
            color: #666;
            font-weight: bold;
            font-size: 14px;
            border-bottom: 1px dashed #999;
            padding-bottom: 5px;
        }

        .photo-item {
            width: 100px;
            background: #fff;
            padding: 5px 5px 20px 5px;
            box-shadow: 2px 2px 5px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            align-items: center;
            cursor: pointer;
            transition: transform 0.2s;
        }
        .photo-item:hover { transform: scale(1.05); z-index: 50; }
        
        .photo-item img {
            width: 100%; height: auto; display: block;
            filter: grayscale(10%);
            background: #000;
        }
        .photo-item .date {
            font-size: 8px; margin-top: 5px; color: #555;
        }

        /* 4. Ïï†ÎãàÎ©îÏù¥ÏÖòÏö© */
        .flying-photo {
            position: fixed;
            width: 140px;
            background: white;
            padding: 8px 8px 30px 8px;
            box-shadow: 5px 5px 20px rgba(0,0,0,0.3);
            z-index: 999;
            pointer-events: none;
            transform-origin: top left;
        }
        .flying-photo img { width: 100%; display: block; }

        /* 5. Î™®Îã¨ & Î≤ÑÌäº */
        .modal {
            display: none; position: fixed; z-index: 2000;
            left: 0; top: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85);
            backdrop-filter: blur(5px);
            flex-direction: column;
            justify-content: center; align-items: center;
        }

        .modal-content {
            position: relative;
            max-width: 90%;
            max-height: 65vh;
            background: white;
            padding: 15px 15px 50px 15px;
            border-radius: 4px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            text-align: center;
        }

        .modal-content img {
            max-width: 100%;
            max-height: 55vh;
            display: block;
        }

        .btn-group {
            margin-top: 20px;
            display: flex;
            gap: 15px;
        }

        .action-btn {
            padding: 12px 20px;
            color: white;
            border: none;
            border-radius: 30px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            transition: transform 0.1s;
            display: flex; align-items: center; gap: 5px;
        }
        .action-btn:active { transform: scale(0.95); }
        
        .save-btn { background-color: #ff7f50; }
        .del-btn { background-color: #555; }

        .close-msg {
            margin-top: 15px; color: rgba(255,255,255,0.6); font-size: 12px;
        }

        .flash {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: white; opacity: 0; pointer-events: none; z-index: 1000;
        }
        .flash.active { animation: flash 0.15s; }
        @keyframes flash { 0% { opacity: 0.8; } 100% { opacity: 0; } }

        @media (max-width: 768px) {
            .main-container {
                flex-direction: column; align-items: center; gap: 20px;
                width: 100%; height: 100vh; padding-top: 20px; box-sizing: border-box;
            }
            .camera-body { transform: scale(0.85); margin-bottom: -20px; }
            .gallery-box {
                width: 90%; flex: 1; height: auto;
                overflow-x: auto; flex-wrap: nowrap;
                align-content: center; align-items: center;
                padding: 10px; background: rgba(255,255,255,0.6);
            }
            .gallery-title { display: none; }
            .photo-item { flex: 0 0 auto; margin-right: 10px; }
        }
    </style>
</head>
<body>
    <div class="flash" id="flash"></div>

    <div class="modal" id="modal">
        <div class="modal-content">
            <img id="modalImg" src="">
            <div style="margin-top:10px; font-size:12px; color:#666; font-family:'Courier New'">#Memory</div>
        </div>
        
        <div class="btn-group">
            <button class="action-btn save-btn" onclick="downloadPhoto()">üíæ Ï†ÄÏû•</button>
            <button class="action-btn del-btn" onclick="deleteCurrentPhoto()">üóë ÏÇ≠Ï†ú</button>
        </div>

        <div class="close-msg" onclick="closeModal()">[ Îã´Í∏∞: ÌôîÎ©¥ Îπà Í≥≥ ÌÑ∞Ïπò ]</div>
    </div>

    <div class="main-container">
        <div class="camera-section">
            <div class="print-slot" id="printSlot"></div>
            <div class="camera-body">
                <div class="lens-ring">
                    <div class="lens-inner">
                        <video id="video" autoplay playsinline muted></video>
                    </div>
                </div>
                <div class="shutter-btn" id="shutterBtn"></div>
            </div>
        </div>

        <div class="gallery-box" id="gallery">
            <div class="gallery-title">MY PHOTO ALBUM</div>
        </div>
    </div>

    <script>
        const video = document.getElementById('video');
        const shutterBtn = document.getElementById('shutterBtn');
        const gallery = document.getElementById('gallery');
        const printSlot = document.getElementById('printSlot');
        const flash = document.getElementById('flash');
        const modal = document.getElementById('modal');
        const modalImg = document.getElementById('modalImg');
        
        let isProcessing = false;
        let currentPhotoData = null; // ÌòÑÏû¨ ÏÑ†ÌÉùÎêú ÏÇ¨ÏßÑ Îç∞Ïù¥ÌÑ∞ (ÏÇ≠Ï†úÏö©)

        // === 1. Îç∞Ïù¥ÌÑ∞Î≤†Ïù¥Ïä§ ÏÑ§Ï†ï (IndexedDB) ===
        let db;
        const DB_NAME = 'PolaroidDB';
        const STORE_NAME = 'photos';

        const request = indexedDB.open(DB_NAME, 1);

        request.onupgradeneeded = (event) => {
            db = event.target.result;
            // idÎ•º ÌÇ§Î°ú ÏÇ¨Ïö©ÌïòÎäî Ï†ÄÏû•ÏÜå ÏÉùÏÑ±
            if (!db.objectStoreNames.contains(STORE_NAME)) {
                db.createObjectStore(STORE_NAME, { keyPath: 'id' });
            }
        };

        request.onsuccess = (event) => {
            db = event.target.result;
            loadSavedPhotos(); // DB Ïó∞Í≤∞ÎêòÎ©¥ Ï†ÄÏû•Îêú ÏÇ¨ÏßÑ Î∂àÎü¨Ïò§Í∏∞
        };

        request.onerror = (event) => {
            console.error("DB ÏóêÎü¨:", event.target.errorCode);
        };

        // === 2. Ïπ¥Î©îÎùº ÏãúÏûë ===
        async function startCamera() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({
                    video: { facingMode: 'user', width: {ideal: 1280}, height: {ideal: 720} },
                    audio: false
                });
                video.srcObject = stream;
            } catch (err) {
                alert("Ïπ¥Î©îÎùº Í∂åÌïúÏù¥ ÌïÑÏöîÌï©ÎãàÎã§.");
            }
        }

        // === 3. ÏÇ¨ÏßÑ Ï¥¨ÏòÅ ===
        function takePhoto() {
            if (isProcessing || video.readyState < 2) return;

            isProcessing = true;
            shutterBtn.classList.add('disabled');

            flash.classList.add('active');
            setTimeout(() => flash.classList.remove('active'), 150);

            const canvas = document.createElement('canvas');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            const ctx = canvas.getContext('2d');
            ctx.translate(canvas.width, 0);
            ctx.scale(-1, 1);
            ctx.drawImage(video, 0, 0);
            
            const imgUrl = canvas.toDataURL('image/jpeg', 0.85); // Ïö©Îüâ ÏµúÏ†ÅÌôî
            const now = new Date();
            const photoData = {
                id: now.getTime(), // Í≥†Ïú† ID (ÏãúÍ∞Ñ)
                url: imgUrl,
                date: `${now.getMonth()+1}/${now.getDate()} ${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}`
            };

            // DBÏóê Ï†ÄÏû•
            savePhotoToDB(photoData);

            // Ïï†ÎãàÎ©îÏù¥ÏÖò Ïã§Ìñâ
            animatePhotoTransfer(photoData);

            setTimeout(() => {
                isProcessing = false;
                shutterBtn.classList.remove('disabled');
            }, 1200);
        }

        // === 4. DB Í¥ÄÎ†® Ìï®Ïàò ===
        function savePhotoToDB(data) {
            const transaction = db.transaction([STORE_NAME], 'readwrite');
            const store = transaction.objectStore(STORE_NAME);
            store.add(data);
        }

        function loadSavedPhotos() {
            const transaction = db.transaction([STORE_NAME], 'readonly');
            const store = transaction.objectStore(STORE_NAME);
            const request = store.getAll();

            request.onsuccess = () => {
                const photos = request.result;
                // ÏµúÏã†ÏàúÏúºÎ°ú Ï†ïÎ†¨ÌïòÏßÄ ÏïäÏúºÎ©¥ ÏòõÎÇ† ÏÇ¨ÏßÑÏù¥ Î®ºÏ†Ä ÎÇòÏò¥
                // Ïó¨Í∏∞ÏÑ† Îã®ÏàúÌïòÍ≤å Î°úÎìú ÌõÑ Ïó≠Ïàú Ï†ïÎ†¨
                // (DB ÌÇ§Í∞Ä ÏãúÍ∞ÑÏàúÏù¥Îùº Í∑∏ÎÉ• Ïó≠ÏàúÏúºÎ°ú ÎøåÎ¶¨Î©¥ Îê®)
                /* Í∏∞Ï°¥ Í∞§Îü¨Î¶¨ ÎπÑÏö∞ÏßÄ ÏïäÍ≥† Ï∂îÍ∞ÄÌïòÎ†§Î©¥ Î°úÏßÅ Î≥µÏû°Ìï¥ÏßÄÎãà,
                   Ï¥àÍ∏∞ Î°úÎî©ÏùÄ ÌïúÎ≤à Ïãπ ÎπÑÏö∞Í≥† Îã§Ïãú Ï±ÑÏö∞ÎäîÍ≤å ÏïàÏ†Ñ */
                // Îã®, Ïï†ÎãàÎ©îÏù¥ÏÖò Ï§ëÏù∏ ÏÇ¨ÏßÑÏù¥ ÏûàÏùÑ Ïàò ÏûàÏúºÎãà Ï†úÎ™©Îßå ÎÇ®Í∏∞Í≥† ÎπÑÏõÄ
                while(gallery.children.length > 1) {
                    gallery.removeChild(gallery.lastChild);
                }
                
                // ÏµúÏã†ÏàúÏúºÎ°ú Î≥¥Ïó¨Ï£ºÍ∏∞ ÏúÑÌï¥ Îí§ÏßëÍ∏∞
                photos.reverse().forEach(photo => {
                    renderPhotoItem(photo);
                });
            };
        }

        function deleteCurrentPhoto() {
            if (!currentPhotoData) return;
            
            if(confirm("Ï†ïÎßê Ïù¥ ÏÇ¨ÏßÑÏùÑ ÏÇ≠Ï†úÌï†ÍπåÏöî?")) {
                const transaction = db.transaction([STORE_NAME], 'readwrite');
                const store = transaction.objectStore(STORE_NAME);
                store.delete(currentPhotoData.id);

                transaction.oncomplete = () => {
                    closeModal();
                    // UIÏóêÏÑúÎèÑ Ìï¥Îãπ ÏÇ¨ÏßÑ Ï†úÍ±∞ (idÎ°ú Ï∞æÍ∏∞)
                    const item = document.getElementById(`photo-${currentPhotoData.id}`);
                    if(item) item.remove();
                };
            }
        }

        // === 5. UI Î†åÎçîÎßÅ Î∞è Ïï†ÎãàÎ©îÏù¥ÏÖò ===
        function renderPhotoItem(data) {
            const item = document.createElement('div');
            item.className = 'photo-item';
            item.id = `photo-${data.id}`; // ÏÇ≠Ï†úÎ•º ÏúÑÌï¥ ID Î∂ÄÏó¨
            
            item.innerHTML = `<img src="${data.url}"><div class="date">${data.date}</div>`;
            item.onclick = () => openModal(data);

            // Í∞§Îü¨Î¶¨ Ï†úÎ™© Îã§Ïùå(Îß® Ïïû)Ïóê Ï∂îÍ∞Ä
            if(gallery.children.length > 1) {
                 gallery.insertBefore(item, gallery.children[1]);
            } else {
                gallery.appendChild(item);
            }
        }

        function animatePhotoTransfer(data) {
            const flyer = document.createElement('div');
            flyer.className = 'flying-photo';
            flyer.innerHTML = `<img src="${data.url}">`;
            document.body.appendChild(flyer);

            const startRect = printSlot.getBoundingClientRect();
            const galleryRect = gallery.getBoundingClientRect();
            const isMobile = window.innerWidth <= 768;

            let targetX = isMobile ? galleryRect.left + 20 : galleryRect.left + 20;
            let targetY = isMobile ? galleryRect.top + 20 : galleryRect.top + 40;

            flyer.animate([
                { top: (startRect.top + 20) + 'px', left: startRect.left + 'px', transform: 'scale(0.8)', opacity: 1, offset: 0 },
                { top: (startRect.top - 80) + 'px', left: startRect.left + 'px', transform: 'scale(1)', opacity: 1, offset: 0.4 },
                { top: targetY + 'px', left: targetX + 'px', transform: 'scale(0.7) rotate(5deg)', opacity: 1, offset: 1 }
            ], { duration: 1200, easing: 'ease-in-out', fill: 'forwards' }).onfinish = () => {
                flyer.remove();
                renderPhotoItem(data); // Ïï†ÎãàÎ©îÏù¥ÏÖò ÎÅùÎÇòÎ©¥ Í∞§Îü¨Î¶¨Ïóê ÌëúÏãú
            };
        }

        // === 6. Î™®Îã¨ Î∞è Îã§Ïö¥Î°úÎìú ===
        function openModal(data) {
            currentPhotoData = data;
            modalImg.src = data.url;
            modal.style.display = 'flex';
        }

        function closeModal() {
            modal.style.display = 'none';
            currentPhotoData = null;
        }

        modal.addEventListener('click', (e) => {
            if (e.target === modal || e.target.classList.contains('close-msg')) {
                closeModal();
            }
        });

        function downloadPhoto() {
            if (!currentPhotoData) return;
            const link = document.createElement('a');
            link.href = currentPhotoData.url;
            link.download = `polaroid_${currentPhotoData.id}.jpg`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        shutterBtn.addEventListener('click', takePhoto);
        shutterBtn.addEventListener('touchstart', (e) => { e.preventDefault(); takePhoto(); });
        startCamera();
    </script>
</body>
</html>
